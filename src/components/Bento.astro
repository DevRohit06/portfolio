---
import Badge from "./Badge.astro";
import Testimonials from "./Testimonials.astro";
import DiscordActivity from "./DiscordActivity.astro";
import BentoItemGithubActivity from "./bento";
import Marquee from "./Marquee.astro";
---

<div
  class="w-[90%] md:w-[80%] lg:w-[70%] mx-auto mt-[50px] sm:mt/[100px] md:mt/[120px] lg:mt/[150px] xl:mt/[200px]"
>
  <div
    class="p-4 sm:p-6 lg:p-10 border border-[#7B7B7B] bento-wrapper opacity-0 invisible bento-container"
  >
    <div class="grid grid-cols-1 lg:grid-cols-8 gap-4 md:gap-6 lg:gap-8">
      <div class="col-span-1 lg:col-span-5 bento-left">
        <div class="flex flex-col gap-4 w-full">
          <div
            class="border border-[#7B7B7B] p-4 bento-github-card bento-scroll-reveal"
            data-delay="0"
          >
            <Badge size="sm" text="GITHUB ACTIVITY">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                class="badge-icon"
                ><path
                  fill="currentColor"
                  d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"
                ></path></svg
              >
            </Badge>

            <!-- <GitHubActivity
              title="GITHUB ACTIVITY"
              username="devrohit06"
              showTooltip={true}
              enableInteraction={true}
              weeks={48}
            /> -->
            <BentoItemGithubActivity server:defer />
          </div>

          <div class="gap-4 sm:gap-6 md:gap-8 mt-4 bento-bottom-cards">
            <div class="h-full w-full">
              <div
                class="border border-[#7B7B7B] p-4 flex flex-col gap-2 sm:gap-0 overflow-hidden hero-skills-section bento-scroll-reveal"
                data-delay="0.2"
              >
                <Badge size="sm"
                  ><span class="font-bold whitespace-nowrap text-xs sm:text-sm">
                    OKAY SO, I AM FAMILIAR WITH:
                  </span></Badge
                >
                <div class="">
                  <Marquee />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        class="col-span-1 lg:col-span-3 row-span-1 lg:row-span-2 gap-4 md:gap-6 lg:gap-8 mt-4 lg:mt-0 bento-right"
      >
        <div class="flex flex-col grid-row-3 gap-4 md:gap-6 lg:gap-8 w-full">
          <div
            class="bento-discord-card bento-scroll-reveal row-span-1"
            data-delay="0.1"
          >
            <DiscordActivity userId="743173584935190620" showButtons={true} />
          </div>
          <div
            class="bento-testimonials h-full bento-scroll-reveal row-span-2"
            data-delay="0.3"
          >
            <Testimonials />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import { createMagneticEffect, createScene } from "../utils/animations.js";

  gsap.registerPlugin(ScrollTrigger);

  document.addEventListener("DOMContentLoaded", () => {
    const bentoContainer = document.querySelector(".bento-container");
    if (!bentoContainer) return;

    // Set initial state for elements with enhanced animations
    gsap.set(".bento-scroll-reveal", {
      opacity: 0,
      scale: 0.85,
      y: 20,
    });

    // Create a scroll trigger for the bento container animation
    ScrollTrigger.create({
      trigger: bentoContainer,
      start: "top 85%", // Trigger earlier for better UX
      once: true, // Only trigger once
      onEnter: () => animateBento(),
    });

    function animateBento() {
      // Make bento container visible first before animations start
      gsap.set(bentoContainer, {
        clipPath: "polygon(0% 100%, 100% 100%, 100% 100%, 0% 100%)",
        opacity: 1,
        visibility: "visible", // Make visible when animation starts
      });

      // Create advanced reveal effect with clipPath
      gsap.to(bentoContainer, {
        clipPath: "polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%)",
        duration: 1.2,
        ease: "expo.inOut",
      });

      // Create scroll-triggered animations for each card with staggered reveal
      const elements = document.querySelectorAll(".bento-scroll-reveal");
      elements.forEach((element) => {
        const delay = element.getAttribute("data-delay")
          ? parseFloat(element.getAttribute("data-delay"))
          : 0;

        gsap.to(element, {
          opacity: 1,
          scale: 1,
          y: 0,
          duration: 1.2,
          delay: delay,
          ease: "back.out(1.5)",
          clearProps: "transform",
        });

        // Add a subtle glow effect
        gsap.fromTo(
          element,
          { boxShadow: "0 0 0 rgba(0, 0, 204, 0)" },
          {
            boxShadow:
              "0 5px 20px rgba(0, 0, 204, 0.15), 0 0 0 rgba(0, 0, 204, 0)",
            duration: 1.5,
            delay: delay + 0.2,
            clearProps: "boxShadow",
          }
        );
      });

      // Add magnetic effect to interactive elements
      createMagneticEffect(".badge-icon", 0.3);
      createMagneticEffect(".bento-github-card a", 0.3);

      // Create scene for advanced animations
      createScene(
        ".bento-wrapper",
        [
          {
            element: ".bento-github-card",
            props: {
              x: 0,
              rotation: 0,
              transformOrigin: "center center",
            },
          },
          {
            element: ".bento-testimonials",
            props: {
              x: 0,
              rotation: 0,
              transformOrigin: "center center",
            },
            position: "-=0.3",
          },
        ],
        {
          start: "top 60%",
          end: "bottom 40%",
          scrub: true,
          markers: false,
        }
      );

      // Add hover effects to all cards
      const bentoCards = document.querySelectorAll(".bento-scroll-reveal");
      bentoCards.forEach((card) => {
        card.addEventListener("mouseenter", () => {
          gsap.to(card, {
            scale: 1.02,
            boxShadow: "0 15px 35px rgba(0, 0, 0, 0.15)",
            y: -5,
            duration: 0.4,
            ease: "power2.out",
          });

          const rect = card.getBoundingClientRect();
          const cardCenterX = rect.left + rect.width / 2;
          const windowCenterX = window.innerWidth / 2;
          const rotationY = (cardCenterX - windowCenterX) * 0.01;

          gsap.to(card, {
            rotationY: rotationY,
            rotationX: -2,
            duration: 0.4,
            ease: "power2.out",
          });
        });

        card.addEventListener("mousemove", (e) => {
          const rect = card.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const mouseY = e.clientY - rect.top;

          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          const rotateY = (mouseX - centerX) / 30;
          const rotateX = (centerY - mouseY) / 30;

          gsap.to(card, {
            rotateY: rotateY,
            rotateX: rotateX,
            duration: 0.3,
            ease: "power2.out",
          });
        });

        card.addEventListener("mouseleave", () => {
          gsap.to(card, {
            scale: 1,
            boxShadow: "none",
            y: 0,
            rotateX: 0,
            rotateY: 0,
            duration: 0.7,
            ease: "elastic.out(1, 0.5)",
          });
        });
      });

      // Add subtle floating effect to selected elements for depth
      const floatingElements = [".bento-testimonials button"];

      floatingElements.forEach((selector, index) => {
        const elements = document.querySelectorAll(selector);
        elements.forEach((element) => {
          const delay = index * 0.4;
          const direction = index % 2 === 0 ? 1 : -1;

          gsap.to(element, {
            y: direction * 5,
            duration: 2 + index * 0.5,
            repeat: -1,
            yoyo: true,
            ease: "sine.inOut",
            delay: delay,
          });
        });
      });
    }

    // Add parallax scroll effect
    ScrollTrigger.create({
      trigger: bentoContainer,
      start: "top bottom",
      end: "bottom top",
      scrub: true,
      onUpdate: (self) => {
        const yPos = (1 - self.progress) * 30; // Move up as it enters viewport
        gsap.to(".bento-container", {
          y: yPos,
          ease: "none",
          overwrite: "auto",
        });
      },
    });
  });
</script>

<style>
  .bento-container {
    will-change: transform, clip-path, opacity, visibility;
  }

  .bento-scroll-reveal {
    will-change: transform, opacity;
    transition: box-shadow 0.3s ease;
  }

  /* Add subtle hover effect on card borders */
  .bento-scroll-reveal {
    position: relative;
    overflow: hidden;
  }

  .bento-scroll-reveal::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* background: linear-gradient(
      45deg,
      transparent 95%,
      rgba(0, 0, 204, 0.5) 100%
    ); */
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .bento-scroll-reveal:hover::before {
    opacity: 0.5;
  }

  .bento-scroll-reveal::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(0, 0, 204, 0.3),
      transparent
    );
    opacity: 0;
    transition: opacity 0.5s;
  }

  .bento-scroll-reveal:hover::after {
    opacity: 1;
  }

  .badge-icon {
    will-change: transform;
    transition: transform 0.3s ease;
  }

  @media (prefers-reduced-motion: reduce) {
    .bento-container {
      opacity: 1;
      visibility: visible;
      clip-path: none;
    }

    .bento-scroll-reveal {
      opacity: 1;
      transform: none !important;
      transition: none !important;
    }

    .floating-animation {
      animation: none !important;
    }
  }
</style>
