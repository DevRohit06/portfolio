---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import { getProjectBySlug, getAllProjectSlugs } from "../../lib/projects";
import { renderMarkdown } from "../../lib/markdownRenderer";
import Badge from "../../components/Badge.astro";
import ThemeChanger from "../../components/svelte/ThemeChanger.svelte";
import ReadmeContent from "../../components/ReadmeContent.astro";
import {
  CalendarIcon,
  RefreshIcon,
  StarIcon,
  GitForkIcon,
  EyeIcon,
  AlertCircleIcon,
  GithubUI_Icon,
  NpmIcon,
  ExternalLinkIcon,
  LicenseIcon,
  GitBranchIcon,
  CodeIcon,
  FileTextIcon,
} from "../../components/icons";

export async function getStaticPaths() {
  const slugs = getAllProjectSlugs();
  return slugs.map((slug) => ({
    params: { slug },
  }));
}

const { slug } = Astro.params;
const project = getProjectBySlug(slug);

if (!project) {
  return Astro.redirect("/404");
}

// Fetch GitHub data from our API
let repoInfo = null;
let readmeContent = null;
let languages = null;

if (project.githubOwner && project.githubRepo) {
  try {
    const apiUrl = new URL(
      `/api/project-repo/${project.githubOwner}/${project.githubRepo}`,
      Astro.url.origin,
    );
    const response = await fetch(apiUrl.toString());

    if (response.ok) {
      const data = await response.json();
      repoInfo = data.repoInfo;
      languages = data.languages;

      // Parse README markdown with syntax highlighting
      if (data.readmeContent) {
        readmeContent = await renderMarkdown(data.readmeContent);
      }
    }
  } catch (error) {
    console.error("Error fetching project data from API:", error);
  }
}

// Calculate language percentages
const languagePercentages = languages
  ? Object.entries(languages)
      .map(([name, bytes]: [string, any]) => {
        const total = Object.values(languages).reduce(
          (sum: number, val: any) => sum + val,
          0,
        );
        return {
          name,
          percentage: ((bytes / total) * 100).toFixed(1),
          bytes,
        };
      })
      .sort((a, b) => b.bytes - a.bytes)
  : [];

// Language colors (GitHub's color scheme)
const languageColors: Record<string, string> = {
  TypeScript: "#3178c6",
  JavaScript: "#f1e05a",
  Python: "#3572A5",
  Java: "#b07219",
  Go: "#00ADD8",
  Rust: "#dea584",
  C: "#555555",
  "C++": "#f34b7d",
  "C#": "#178600",
  Ruby: "#701516",
  PHP: "#4F5D95",
  Swift: "#F05138",
  Kotlin: "#A97BFF",
  Dart: "#00B4AB",
  Shell: "#89e051",
  HTML: "#e34c26",
  CSS: "#563d7c",
  Vue: "#41b883",
  Svelte: "#ff3e00",
  Astro: "#ff5a03",
};

const githubUrl =
  project.githubOwner && project.githubRepo
    ? `https://github.com/${project.githubOwner}/${project.githubRepo}`
    : undefined;

// Normalize canonical URL without trailing slash
const canonicalURL = new URL(
  `/projects/${slug}`,
  Astro.site || Astro.url.origin,
).href;
---

<Layout
  title={`${project.title} - Rohit Kushwaha`}
  description={project.description}
  ogImage={repoInfo?.owner?.avatar_url || project.image}
  canonicalURL={canonicalURL}
>
  <div class="page-content">
    <Navbar />

    <div
      class="w-[90%] md:w-[80%] lg:w-[90%] xl:w-[70%] 2xl:w-[60%] mx-auto mt-[80px] md:mt-[100px] pb-16"
    >
      <!-- Project Header (similar to blog header) -->
      <div class="project-hero mb-8 md:mb-12">
        <div class="project-meta mb-4">
          <!-- Tags -->
          {
            project.tags && project.tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mb-3">
                {project.tags.map((tag) => (
                  <Badge text={tag} size="sm" />
                ))}
              </div>
            )
          }

          <!-- Title -->
          <h1
            class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold mb-3 font-sans text-primary"
          >
            {project.title}
          </h1>

          <!-- Meta info -->
          <div class="flex flex-wrap items-center text-sm text-secondary gap-4">
            {
              repoInfo && (
                <span class="flex items-center gap-1">
                  <CalendarIcon size="w-4 h-4" />
                  Created: {new Date(repoInfo.created_at).toLocaleDateString()}
                </span>
              )
            }
            {
              repoInfo && (
                <span class="flex items-center gap-1">
                  <RefreshIcon size="w-4 h-4" />
                  Updated: {new Date(repoInfo.updated_at).toLocaleDateString()}
                </span>
              )
            }
            <span
              class={`px-2 py-1 text-xs font-medium ${
                project.status === "Completed"
                  ? "bg-green-500 text-black border border-green-500/20"
                  : "bg-yellow-500 text-black border border-yellow-500/20"
              }`}
            >
              {project.status}
            </span>
          </div>
        </div>

        <!-- Project Image -->
        <div
          class="relative w-full aspect-video overflow-hidden border border-secondary mt-6"
        >
          <img
            src={project.image}
            alt={project.title}
            class="w-full h-full object-cover"
          />
        </div>
      </div>

      <!-- Main Content Layout -->
      <div class="project-layout grid grid-cols-1 lg:grid-cols-6 gap-8">
        <!-- Sidebar -->
        <div class="sidebar-container lg:col-span-2">
          <!-- Mobile/Tablet Tab Selector -->
          <div class="tab-selector lg:hidden mb-4">
            <select
              id="sidebarSelect"
              class="w-full p-3 bg-card border border-secondary text-primary cursor-pointer hover:border-accent"
            >
              <option value="stats">Repository Stats</option>
              <option value="languages">Languages</option>
              <option value="links">Links</option>
              <option value="tech">Technologies</option>
              <option value="info">Additional Info</option>
            </select>
          </div>

          <div class="sidebar-content">
            <div class="lg:sticky lg:top-24">
              <!-- Theme Toggle -->
              <div class="theme-toggle-container flex justify-end mb-4">
                <ThemeChanger client:load />
              </div>

              <!-- GitHub Data Status -->
              {
                !repoInfo && project.githubOwner && project.githubRepo && (
                  <div class="border border-yellow-500/20 bg-yellow-500/5 p-4 mb-4 text-sm">
                    <p class="text-yellow-500/90">
                      <AlertCircleIcon size="w-4 h-4 inline mr-2" />
                      GitHub data temporarily unavailable. Showing project info
                      only.
                    </p>
                  </div>
                )
              }

              <!-- Repository Stats -->
              {
                repoInfo ? (
                  <div
                    class="sidebar-card border border-secondary p-4 bg-card mb-4"
                    data-section="stats"
                  >
                    <h2 class="text-lg font-medium mb-4 text-primary">
                      Repository Stats
                    </h2>
                    <div class="stats-grid grid grid-cols-2 gap-3">
                      <div class="stat-item flex items-center gap-2 p-3 border border-secondary">
                        <StarIcon size="w-6 h-6 text-accent flex-shrink-0" />
                        <div class="flex flex-col">
                          <span class="stat-value text-lg font-semibold text-primary">
                            {repoInfo.stargazers_count.toLocaleString()}
                          </span>
                          <span class="stat-label text-xs text-secondary uppercase tracking-wide">
                            Stars
                          </span>
                        </div>
                      </div>
                      <div class="stat-item flex items-center gap-2 p-3  border border-secondary">
                        <GitForkIcon size="w-6 h-6 text-accent flex-shrink-0" />
                        <div class="flex flex-col">
                          <span class="stat-value text-lg font-semibold text-primary">
                            {repoInfo.forks_count.toLocaleString()}
                          </span>
                          <span class="stat-label text-xs text-secondary uppercase tracking-wide">
                            Forks
                          </span>
                        </div>
                      </div>
                      <div class="stat-item flex items-center gap-2 p-3  border border-secondary">
                        <EyeIcon size="w-6 h-6 text-accent flex-shrink-0" />
                        <div class="flex flex-col">
                          <span class="stat-value text-lg font-semibold text-primary">
                            {repoInfo.watchers_count.toLocaleString()}
                          </span>
                          <span class="stat-label text-xs text-secondary uppercase tracking-wide">
                            Watch
                          </span>
                        </div>
                      </div>
                      <div class="stat-item flex items-center gap-2 p-3  border border-secondary">
                        <AlertCircleIcon size="w-6 h-6 text-accent flex-shrink-0" />
                        <div class="flex flex-col">
                          <span class="stat-value text-lg font-semibold text-primary">
                            {repoInfo.open_issues_count.toLocaleString()}
                          </span>
                          <span class="stat-label text-xs text-secondary uppercase tracking-wide">
                            Issues
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                ) : null
              }

              <!-- Languages -->
              {
                languagePercentages.length > 0 && (
                  <div
                    class="sidebar-card border border-secondary p-4 bg-card mb-4"
                    data-section="languages"
                  >
                    <h2 class="text-lg font-medium mb-4 text-primary">
                      Languages
                    </h2>
                    <div class="languages">
                      {/* Language bar */}
                      <div class="language-bar flex h-2 border border-secondary mb-4 overflow-hidden">
                        {languagePercentages.map((lang) => (
                          <div
                            class="language-segment"
                            style={`width: ${lang.percentage}%; background-color: ${languageColors[lang.name] || "#858585"};`}
                            title={`${lang.name}: ${lang.percentage}%`}
                          />
                        ))}
                      </div>
                      {/* Language list */}
                      <ul class="language-list space-y-2">
                        {languagePercentages.map((lang) => (
                          <li class="language-item flex items-center justify-between text-sm">
                            <div class="flex items-center gap-2">
                              <span
                                class="language-color w-3 h-3 border border-secondary flex-shrink-0"
                                style={`background-color: ${languageColors[lang.name] || "#858585"};`}
                              />
                              <span class="language-name text-primary">
                                {lang.name}
                              </span>
                            </div>
                            <span class="language-percentage text-secondary font-medium">
                              {lang.percentage}%
                            </span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>
                )
              }

              <!-- Links -->
              <div
                class="sidebar-card border border-secondary p-4 bg-card mb-4"
                data-section="links"
              >
                <h2 class="text-lg font-medium mb-4 text-primary">Links</h2>
                <div class="links flex flex-col gap-3">
                  {
                    githubUrl && (
                      <a
                        href={githubUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="link-button flex items-center gap-3 p-3  border border-secondary text-primary hover:border-accent  "
                      >
                        <GithubUI_Icon size="w-5 h-5 flex-shrink-0" />
                        <span class="font-medium">View on GitHub</span>
                      </a>
                    )
                  }
                  {
                    project.npm && (
                      <a
                        href={project.npm}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="link-button flex items-center gap-3 p-3  border border-secondary text-primary hover:border-accent  "
                      >
                        <NpmIcon size="w-5 h-5 flex-shrink-0" />
                        <span class="font-medium">View on NPM</span>
                      </a>
                    )
                  }
                  {
                    project.demo && (
                      <a
                        href={project.demo}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="link-button flex items-center gap-3 p-3  border border-secondary text-primary hover:border-accent  "
                      >
                        <ExternalLinkIcon size="w-5 h-5 flex-shrink-0" />
                        <span class="font-medium">Live Demo</span>
                      </a>
                    )
                  }
                </div>
              </div>

              <!-- Technologies -->
              {
                project.technologies && project.technologies.length > 0 && (
                  <div
                    class="sidebar-card border border-secondary p-4 bg-card mb-4"
                    data-section="tech"
                  >
                    <h2 class="text-lg font-medium mb-4 text-primary">
                      Technologies
                    </h2>
                    <div class="flex flex-wrap gap-2">
                      {project.technologies.map((tech) => (
                        <span class="px-3 py-1 text-xs font-medium  border border-secondary text-primary">
                          {tech}
                        </span>
                      ))}
                    </div>
                  </div>
                )
              }

              <!-- Additional Info -->
              {
                repoInfo && (
                  <div
                    class="sidebar-card border border-secondary p-4 bg-card"
                    data-section="info"
                  >
                    <h2 class="text-lg font-medium mb-4 text-primary">
                      Additional Info
                    </h2>
                    <div class="space-y-2 text-sm text-secondary">
                      {repoInfo.license && (
                        <div class="flex items-center gap-2">
                          <LicenseIcon size="w-4 h-4 text-accent" />
                          <span>License: {repoInfo.license.name}</span>
                        </div>
                      )}
                      <div class="flex items-center gap-2">
                        <GitBranchIcon size="w-4 h-4 text-accent" />
                        <span>Default Branch: {repoInfo.default_branch}</span>
                      </div>
                      {repoInfo.language && (
                        <div class="flex items-center gap-2">
                          <CodeIcon size="w-4 h-4 text-accent" />
                          <span>Primary Language: {repoInfo.language}</span>
                        </div>
                      )}
                    </div>
                  </div>
                )
              }
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="lg:col-span-4">
          <!-- Description -->
          <div
            class="project-description mb-8 p-6 bg-card border border-secondary"
          >
            <h2 class="text-xl font-bold mb-3 text-primary">About</h2>
            <p class="text-secondary leading-relaxed">{project.description}</p>
          </div>

          <!-- README Content -->
          {
            readmeContent ? (
              <div class="readme-section">
                <h2 class="text-2xl font-bold mb-6 text-primary flex items-center gap-2">
                  <FileTextIcon size="w-7 h-7 text-accent" />
                  Documentation
                </h2>
                <div class="readme-content border border-secondary p-6 bg-card">
                  <ReadmeContent content={readmeContent} />
                </div>
              </div>
            ) : (
              <div class="no-readme border border-secondary p-12 bg-card text-center">
                <FileTextIcon size="w-16 h-16 text-secondary/50 mx-auto mb-4" />
                <p class="text-lg text-secondary">
                  README not available for this project
                </p>
                <p class="text-sm text-secondary/70 mt-2">
                  Check the repository for more information
                </p>
              </div>
            )
          }
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .page-content {
    min-height: 100vh;
  }

  .text-primary {
    color: var(--text-primary);
  }

  .text-secondary {
    color: var(--text-secondary);
  }

  .text-accent {
    color: var(--accent-primary);
  }

  . {
    background: var(--);
  }

  .bg-card {
    background: var(--bg-secondary);
  }

  .border-secondary {
    border-color: var(--border-color);
  }

  .sidebar-card h2 {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
  }

  .link-button:hover {
    background: var(--bg-secondary);
  }

  /* Tab selector styling */
  .tab-selector select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1.25rem;
    padding-right: 2.5rem;
  }

  .tab-selector select:focus {
    outline: none;
    border-color: var(--accent-primary);
  }

  /* Sidebar sections - hidden by default on mobile, show only when active */
  .sidebar-card {
    display: none !important;
  }

  .sidebar-card.active {
    display: block !important;
  }

  .theme-toggle-container {
    display: none !important;
  }

  /* Desktop - show all sections and hide select */
  @media (min-width: 1024px) {
    .tab-selector {
      display: none !important;
    }

    .sidebar-card {
      display: block !important;
    }

    .theme-toggle-container {
      display: flex !important;
    }
  }

  /* Make sure all borders are NOT rounded */
  * {
    border-radius: 0 !important;
  }

  /* Language segment hover effect */
  .language-segment {
    transition: opacity 0.3s ease-in-out;
  }

  .language-segment:hover {
    opacity: 0.8;
  }

  /* Tablet and mobile responsiveness */
  @media (max-width: 1024px) {
    .project-layout {
      display: flex;
      flex-direction: column;
    }

    .sidebar-container {
      order: -1; /* Keep sidebar at top on mobile/tablet */
    }

    .sidebar-card {
      margin-bottom: 1rem;
    }

    /* Adjust stats grid for smaller screens */
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .sticky {
      position: static !important;
    }
  }

  @media (max-width: 640px) {
    /* Stack stats on very small screens */
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .stat-item {
      padding: 0.75rem;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import { cleanupGSAPAnimations } from "../../utils/animations.js";
  import Lenis from "lenis";

  gsap.registerPlugin(ScrollTrigger);

  // Initialize Lenis smooth scroll
  const lenis = new Lenis({
    duration: 1.2,
    easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
  } as any);

  function raf(time: number) {
    lenis.raf(time);
    requestAnimationFrame(raf);
  }

  requestAnimationFrame(raf);

  // GSAP animations on page load
  const runGSAPAnimations = () => {
    // Animate project hero
    gsap.from(".project-hero", {
      opacity: 0,
      y: 30,
      duration: 0.8,
      ease: "power2.out",
    });

    // Animate sidebar cards
    gsap.from(".sidebar-card", {
      opacity: 0,
      x: -30,
      duration: 0.6,
      stagger: 0.1,
      ease: "power2.out",
      delay: 0.3,
    });

    // Animate main content
    gsap.from(".project-description, .readme-section, .no-readme", {
      opacity: 0,
      y: 30,
      duration: 0.8,
      stagger: 0.2,
      ease: "power2.out",
      delay: 0.4,
    });

    // Animate stats on scroll
    const statItems = document.querySelectorAll(".stat-item");
    if (statItems.length > 0) {
      gsap.from(statItems, {
        scale: 0.9,
        opacity: 0,
        duration: 0.5,
        stagger: 0.1,
        ease: "back.out(1.7)",
        scrollTrigger: {
          trigger: ".stats-grid",
          start: "top 80%",
        },
      });
    }
  };

  // Run GSAP on page load
  document.addEventListener("astro:page-load", runGSAPAnimations);

  // Also run immediately
  if (document.readyState !== "loading") {
    runGSAPAnimations();
  }

  // Cleanup on navigation
  document.addEventListener("astro:before-preparation", () => {
    cleanupGSAPAnimations();
  });
</script>

<!-- Inline script to run immediately -->
<script is:inline>
  console.log("ðŸš€ Inline script running immediately");

  function initializeSidebar() {
    console.log("ðŸ“ initializeSidebar called");

    const sidebarSelect = document.getElementById("sidebarSelect");
    const sidebarCards = document.querySelectorAll(".sidebar-card");

    console.log("Select found:", !!sidebarSelect);
    console.log("Cards found:", sidebarCards.length);

    if (!sidebarSelect || sidebarCards.length === 0) {
      console.log("âŒ Elements not ready, retrying in 50ms");
      setTimeout(initializeSidebar, 50);
      return;
    }

    console.log("âœ… Elements ready, initializing");

    // Show first section on mobile
    const showFirstSection = () => {
      if (window.innerWidth < 1024) {
        sidebarCards.forEach((card) => card.classList.remove("active"));
        sidebarCards[0].classList.add("active");
        console.log("âœ… First section active on mobile");
      }
    };

    showFirstSection();

    // Handle select change
    sidebarSelect.addEventListener("change", function () {
      const selectedValue = this.value;
      console.log("ðŸ“ Changed to:", selectedValue);

      sidebarCards.forEach((card) => {
        card.classList.remove("active");
      });

      const selectedCard = document.querySelector(
        `.sidebar-card[data-section="${selectedValue}"]`,
      );
      if (selectedCard) {
        selectedCard.classList.add("active");
        console.log("âœ… Activated:", selectedValue);
        setTimeout(() => {
          selectedCard.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }, 100);
      }
    });

    // Handle resize
    window.addEventListener("resize", () => {
      if (window.innerWidth >= 1024) {
        sidebarCards.forEach((card) => card.classList.remove("active"));
      } else {
        showFirstSection();
      }
    });
  }

  // Run immediately
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeSidebar);
  } else {
    initializeSidebar();
  }

  // Also run on Astro transitions
  document.addEventListener("astro:page-load", initializeSidebar);
  document.addEventListener("astro:after-swap", initializeSidebar);
</script>
