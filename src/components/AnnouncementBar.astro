---
interface Props {
  id: string;
  href: string;
  text: string;
}

const { id, href, text } = Astro.props;
---

<div
  id={`announcement-${id}`}
  class="announcement-bar"
  data-announcement-id={id}
>
  <script is:inline define:vars={{ id }}>
    // Immediately hide if dismissed (prevents flash)
    if (localStorage.getItem(`announcement-dismissed-${id}`) === 'true') {
      document.currentScript.parentElement.style.display = 'none';
    }
  </script>
  <a href={href} target="_blank" rel="noopener noreferrer" class="announcement-link">
    <span class="announcement-badge">NEW</span>
    <span class="announcement-text">{text}</span>
    <span class="announcement-arrow">â†’</span>
  </a>
  <button
    class="announcement-close"
    aria-label="Dismiss announcement"
    data-dismiss={id}
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>
</div>

<style>
  .announcement-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 0.875rem;
    position: relative;
    z-index: 100;
    border-bottom: 1px solid var(--border-color);
  }

  .announcement-bar.hidden {
    display: none;
  }

  .announcement-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: inherit;
    text-decoration: none;
    font-weight: 500;
  }

  .announcement-link:hover .announcement-arrow {
    transform: translateX(3px);
  }

  .announcement-badge {
    background: var(--accent-primary);
    color: var(--bg-primary);
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.625rem;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .announcement-text {
    opacity: 0.95;
  }

  .announcement-arrow {
    color: var(--accent-primary);
    transition: transform 0.2s ease;
  }

  .announcement-close {
    position: absolute;
    right: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem;
    background: transparent;
    border: none;
    color: inherit;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .announcement-close:hover {
    opacity: 1;
  }

  @media (max-width: 640px) {
    .announcement-bar {
      padding: 0.5rem 2.5rem 0.5rem 0.75rem;
      font-size: 0.75rem;
    }

    .announcement-badge {
      font-size: 0.5rem;
      padding: 0.125rem 0.375rem;
    }
  }
</style>

<script>
  function initAnnouncementBars() {
    const bars = document.querySelectorAll('.announcement-bar');

    bars.forEach((bar) => {
      const id = bar.getAttribute('data-announcement-id');
      const dismissKey = `announcement-dismissed-${id}`;

      // Check if already dismissed
      if (localStorage.getItem(dismissKey) === 'true') {
        bar.classList.add('hidden');
        return;
      }

      // Setup dismiss button
      const closeBtn = bar.querySelector('.announcement-close');
      closeBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.setItem(dismissKey, 'true');
        bar.classList.add('hidden');
      });
    });
  }

  // Run on initial load and after Astro navigation
  initAnnouncementBars();
  document.addEventListener('astro:page-load', initAnnouncementBars);
</script>
